# ç±»å›¾å’ŒåŒ…å›¾è¯¦ç»†è®¾è®¡

## 1. å®Œæ•´ç±»å›¾ï¼ˆMermaidï¼‰

### 1.1 æ•´ä½“ç±»å›¾

```mermaid
classDiagram
    direction LR
    
    %% å®ä½“ç±»å±‚
    class Room {
        -String id
        -String name
        -number capacity
        -String|null password
        -String announcement
        -String status
        -VideoState videoState
        -Map participants
        -String creatorId
        -Date createTime
        -Date updateTime
        
        +hasPassword() boolean
        +validatePassword(password) boolean
        +isFull() boolean
        +getOnlineCount() number
        +addParticipant(participantData) Participant
        +removeParticipant(participantId) boolean
        +getParticipant(participantId) Participant
        +getCreator() Participant
        +isCreator(participantId) boolean
        +updateConfig(config) void
        +setStatus(status) void
        +close() void
        +toListJSON() Object
        +toDetailJSON() Object
    }

    class VideoState {
        -String|null source
        -String status
        -number progress
        -number playbackRate
        -String|null subtitle
        -number lastUpdateTime
        
        +setSource(source) void
        +setStatus(status) void
        +setProgress(progress) void
        +setPlaybackRate(rate) void
        +getCurrentProgress() number
        +toJSON() Object
    }

    class Participant {
        -String id
        -String nickname
        -String role
        -String status
        -Date joinTime
        -String|null socketId
        
        +isCreator() boolean
        +setStatus(status) void
        +setSocketId(socketId) void
        +toJSON() Object
    }

    %% æœåŠ¡å±‚ç±»
    class RoomService {
        -RoomRepository roomRepository
        
        +createRoom(createData) Promise
        +getRoomList(options) Promise
        +getRoomDetail(roomId) Promise
        +joinRoom(roomId, joinData) Promise
        +leaveRoom(roomId, participantId) Promise
        +dissolveRoom(roomId, operatorId) Promise
        +updateRoom(roomId, operatorId, updateData) Promise
        +verifyRoomPassword(roomId, password) Promise
        +getRoomStats() Promise
        +roomExists(roomId) boolean
        -validateCreateParams(data) void
    }

    %% æ§åˆ¶å™¨å±‚ç±»
    class RoomController {
        -RoomService roomService
        
        +createRoom(req, res, next) void
        +getRoomList(req, res, next) void
        +getRoomDetail(req, res, next) void
        +joinRoom(req, res, next) void
        +leaveRoom(req, res, next) void
        +dissolveRoom(req, res, next) void
        +updateRoom(req, res, next) void
        +verifyPassword(req, res, next) void
        +getRoomStats(req, res, next) void
    }

    %% æ•°æ®è®¿é—®å±‚ç±»
    class RoomRepository {
        -Map rooms
        
        +create(roomData) Room
        +findById(roomId) Room|null
        +findAll(options) Room[]
        +update(roomId, updateData) Room|null
        +delete(roomId) boolean
        +exists(roomId) boolean
        +count(excludeClosed) number
        +search(criteria) Room[]
        +clear() void
        -generateUniqueRoomId() String
    }

    %% å¼‚å¸¸å±‚ç±»
    class BusinessException {
        -String message
        -String errorCode
        -number statusCode
    }

    class RoomNotFoundException {
        -String roomId
    }

    class RoomFullException {
        -String roomId
    }

    class InvalidPasswordException {
    }

    class PermissionDeniedException {
        -String action
    }

    class ValidationException {
        -Object|null details
    }

    class RoomClosedException {
        -String roomId
    }

    %% å·¥å…·å±‚ç±»
    class ResponseHelper {
        +success(res, data, message, statusCode) Object
        +created(res, data, message) Object
        +error(res, statusCode, message, errorCode, details) Object
        +badRequest(res, message, details) Object
        +unauthorized(res, message) Object
        +forbidden(res, message) Object
        +notFound(res, message) Object
        +conflict(res, message) Object
        +serverError(res, message) Object
    }

    class IdGenerator {
        +generateRoomId(length) String
        +generateUUID() String
        +generateTimestampId() String
    }

    class Config {
        +server Object
        +room Object
        +cors Object
    }

    %% ä¸­é—´ä»¶ç±»
    class ErrorHandler {
        +errorHandler(err, req, res, next) void
        +notFoundHandler(req, res) void
    }

    class RequestLogger {
        +requestLogger(req, res, next) void
    }

    %% å…³ç³»å®šä¹‰
    Room "1" --> "1" VideoState : åŒ…å«
    Room "1" --> "*" Participant : åŒ…å«
    
    RoomService --> RoomRepository : ä½¿ç”¨
    RoomService --> IdGenerator : ä½¿ç”¨
    RoomController --> RoomService : è°ƒç”¨
    RoomController --> ResponseHelper : ä½¿ç”¨
    
    RoomRepository --> Room : ç®¡ç†
    RoomRepository --> IdGenerator : ä½¿ç”¨
    
    BusinessException <|-- RoomNotFoundException
    BusinessException <|-- RoomFullException
    BusinessException <|-- InvalidPasswordException
    BusinessException <|-- PermissionDeniedException
    BusinessException <|-- ValidationException
    BusinessException <|-- RoomClosedException
    
    RoomService --|> BusinessException : æŠ›å‡º
    ErrorHandler --> BusinessException : å¤„ç†
```

### 1.2 å®ä½“ç±»è¯¦ç»†å›¾

```mermaid
classDiagram
    direction TB
    
    class Room {
        -String id
        -String name
        -number capacity
        -String password
        -String announcement
        -String status
        -VideoState videoState
        -Map~String,Participant~ participants
        -String creatorId
        -Date createTime
        -Date updateTime
        
        +hasPassword() boolean
        +validatePassword(String) boolean
        +isFull() boolean
        +getOnlineCount() number
        +addParticipant(Object) Participant
        +removeParticipant(String) boolean
        +getParticipant(String) Participant
        +getCreator() Participant
        +isCreator(String) boolean
        +updateConfig(Object) void
        +setStatus(String) void
        +close() void
        +toListJSON() Object
        +toDetailJSON() Object
    }

    class VideoState {
        -String source
        -String status
        -number progress
        -number playbackRate
        -String subtitle
        -number lastUpdateTime
        
        +setSource(String) void
        +setStatus(String) void
        +setProgress(number) void
        +setPlaybackRate(number) void
        +getCurrentProgress() number
        +toJSON() Object
    }

    class Participant {
        -String id
        -String nickname
        -String role
        -String status
        -Date joinTime
        -String socketId
        
        +isCreator() boolean
        +setStatus(String) void
        +setSocketId(String) void
        +toJSON() Object
    }

    class Enum_RoomStatus {
        WAITING
        PLAYING
        CLOSED
    }

    class Enum_PlayStatus {
        PLAYING
        PAUSED
        STOPPED
    }

    class Enum_ParticipantRole {
        CREATOR
        VIEWER
    }

    class Enum_ParticipantStatus {
        ONLINE
        OFFLINE
    }

    Room --> VideoState : æ‹¥æœ‰
    Room --> Participant : æ‹¥æœ‰
    Room --> Enum_RoomStatus : ä½¿ç”¨
    VideoState --> Enum_PlayStatus : ä½¿ç”¨
    Participant --> Enum_ParticipantRole : ä½¿ç”¨
    Participant --> Enum_ParticipantStatus : ä½¿ç”¨
```

### 1.3 ä¸šåŠ¡é€»è¾‘å±‚ç±»å›¾

```mermaid
classDiagram
    direction LR
    
    class RoomService {
        -RoomRepository roomRepository
        -static RoomService instance
        
        +static getInstance() RoomService
        +createRoom(Object) Promise
        +getRoomList(Object) Promise
        +getRoomDetail(String) Promise
        +joinRoom(String, Object) Promise
        +leaveRoom(String, String) Promise
        +dissolveRoom(String, String) Promise
        +updateRoom(String, String, Object) Promise
        +verifyRoomPassword(String, String) Promise
        +getRoomStats() Promise
        +roomExists(String) boolean
        -validateCreateParams(Object) void
    }

    class RoomRepository {
        -Map~String,Room~ rooms
        -static RoomRepository instance
        
        +static getInstance() RoomRepository
        +create(Object) Room
        +findById(String) Room
        +findAll(Object) Room[]
        +update(String, Object) Room
        +delete(String) boolean
        +exists(String) boolean
        +count(boolean) number
        +search(Object) Room[]
        +clear() void
        -generateUniqueRoomId() String
    }

    class RoomController {
        -RoomService roomService
        -static RoomController instance
        
        +static getInstance() RoomController
        +createRoom(Object, Object, Function) void
        +getRoomList(Object, Object, Function) void
        +getRoomDetail(Object, Object, Function) void
        +joinRoom(Object, Object, Function) void
        +leaveRoom(Object, Object, Function) void
        +dissolveRoom(Object, Object, Function) void
        +updateRoom(Object, Object, Function) void
        +verifyPassword(Object, Object, Function) void
        +getRoomStats(Object, Object, Function) void
    }

    RoomService --> RoomRepository : ä½¿ç”¨
    RoomController --> RoomService : ä½¿ç”¨
```

### 1.4 å¼‚å¸¸ä½“ç³»ç±»å›¾

```mermaid
classDiagram
    direction TB
    
    class Error {
        <<abstract>>
        -String message
        -String stack
    }

    class BusinessException {
        <<abstract>>
        -String message
        -String errorCode
        -number statusCode
    }

    class RoomNotFoundException {
        -String roomId
    }

    class RoomFullException {
        -String roomId
    }

    class InvalidPasswordException {
    }

    class PermissionDeniedException {
        -String action
    }

    class ValidationException {
        -Object details
    }

    class RoomClosedException {
        -String roomId
    }

    Error <|-- BusinessException
    BusinessException <|-- RoomNotFoundException
    BusinessException <|-- RoomFullException
    BusinessException <|-- InvalidPasswordException
    BusinessException <|-- PermissionDeniedException
    BusinessException <|-- ValidationException
    BusinessException <|-- RoomClosedException
```

---

## 2. åŒ…å›¾ï¼ˆMermaidï¼‰

### 2.1 å®Œæ•´åŒ…ç»“æ„å›¾

```mermaid
graph TB
    subgraph Backend["backend-online-movie-house"]
        subgraph Application["åº”ç”¨å±‚ (Application Layer)"]
            subgraph Controllers["ğŸ‘¤ controllers"]
                RoomCtrl["<b>RoomController</b><br/>- createRoom()<br/>- getRoomList()<br/>- getRoomDetail()<br/>- joinRoom()<br/>- leaveRoom()<br/>- dissolveRoom()<br/>- updateRoom()"]
            end
            
            subgraph Routes["ğŸ›£ï¸ routes"]
                RoomRoute["<b>roomRoutes</b><br/>- createRoomRouter()<br/>- GET /api/rooms<br/>- POST /api/rooms<br/>- POST /:roomId/join<br/>- DELETE /:roomId"]
            end
            
            subgraph Middlewares["âš™ï¸ middlewares"]
                ErrorHandler["<b>errorHandler</b><br/>- errorHandler()<br/>- notFoundHandler()"]
                RequestLogger["<b>requestLogger</b><br/>- requestLogger()"]
            end
            
            subgraph MainApp["ğŸ“± app.js"]
                AppMain["<b>createApp()</b><br/>- ä¸­é—´ä»¶é…ç½®<br/>- è·¯ç”±æ³¨å†Œ<br/>- é”™è¯¯å¤„ç†"]
            end
        end
        
        subgraph BusinessLogic["ä¸šåŠ¡é€»è¾‘å±‚ (Business Logic Layer)"]
            subgraph Services["ğŸ”§ services"]
                RoomSvc["<b>RoomService</b><br/>- createRoom()<br/>- getRoomList()<br/>- getRoomDetail()<br/>- joinRoom()<br/>- leaveRoom()<br/>- dissolveRoom()<br/>- updateRoom()<br/>- verifyRoomPassword()"]
            end
            
            subgraph Exceptions["âŒ exceptions"]
                BusExc["<b>BusinessException</b><br/>- message<br/>- errorCode<br/>- statusCode"]
                RoomNotFound["<b>RoomNotFoundException</b>"]
                RoomFull["<b>RoomFullException</b>"]
                InvalidPwd["<b>InvalidPasswordException</b>"]
                PermDenied["<b>PermissionDeniedException</b>"]
                ValExc["<b>ValidationException</b>"]
                RoomClosed["<b>RoomClosedException</b>"]
            end
        end
        
        subgraph DataAccess["æ•°æ®è®¿é—®å±‚ (Data Access Layer)"]
            subgraph Repositories["ğŸ“¦ repositories"]
                RoomRepo["<b>RoomRepository</b><br/>- create()<br/>- findById()<br/>- findAll()<br/>- update()<br/>- delete()<br/>- search()<br/>- count()"]
            end
        end
        
        subgraph Model["å®ä½“æ¨¡å‹å±‚ (Entity Layer)"]
            subgraph Models["ğŸ›ï¸ models"]
                RoomModel["<b>Room</b><br/>- id: string<br/>- name: string<br/>- capacity: number<br/>- participants: Map<br/>- videoState: VideoState"]
                VideoState["<b>VideoState</b><br/>- source: string<br/>- status: string<br/>- progress: number<br/>- playbackRate: number"]
                Participant["<b>Participant</b><br/>- id: string<br/>- nickname: string<br/>- role: string<br/>- status: string"]
                ModelIndex["<b>index.js</b><br/>- ç»Ÿä¸€å¯¼å‡º"]
            end
        end
        
        subgraph Infrastructure["åŸºç¡€è®¾æ–½å±‚ (Infrastructure Layer)"]
            subgraph Utils["ğŸ”¨ utils"]
                RespHelper["<b>ResponseHelper</b><br/>- success()<br/>- error()<br/>- badRequest()<br/>- created()"]
                IdGen["<b>IdGenerator</b><br/>- generateRoomId()<br/>- generateUUID()<br/>- generateTimestampId()"]
            end
            
            subgraph ConfigPkg["âš™ï¸ config"]
                ConfigFile["<b>index.js</b><br/>- server config<br/>- room config<br/>- cors config"]
            end
        end
    end
    
    Client["ğŸ‘¥ å‰ç«¯åº”ç”¨<br/>(Vue.js)"]
    Memory["ğŸ’¾ å†…å­˜å­˜å‚¨"]
    
    style Application fill:#E1F5FF,stroke:#01579B,color:#000
    style BusinessLogic fill:#F3E5F5,stroke:#4A148C,color:#000
    style DataAccess fill:#E8F5E9,stroke:#1B5E20,color:#000
    style Model fill:#FFF3E0,stroke:#E65100,color:#000
    style Infrastructure fill:#F1F8E9,stroke:#33691E,color:#000
    
    Client -->|HTTP REST| AppMain
    AppMain --> RoomRoute
    RoomRoute --> RoomCtrl
    RoomCtrl --> RespHelper
    RoomCtrl --> RoomSvc
    RoomSvc --> RoomRepo
    RoomRepo --> RoomModel
    RoomRepo --> Memory
    RoomSvc --> Exceptions
    RoomSvc --> IdGen
    AppMain --> Middlewares
    AppMain --> ConfigFile
    Exceptions --> BusExc
    BusExc --> RoomNotFound
    BusExc --> RoomFull
    BusExc --> InvalidPwd
    BusExc --> PermDenied
    BusExc --> ValExc
    BusExc --> RoomClosed
```

### 2.2 åº”ç”¨å±‚åŒ…å›¾

```mermaid
graph TB
    subgraph AppLayer["åº”ç”¨å±‚ (Application)"]
        subgraph Controllers["ğŸ‘¤ controllers"]
            direction TB
            RoomCtrl["RoomController<br/><br/>- createRoom()<br/>- getRoomList()<br/>- getRoomDetail()<br/>- joinRoom()<br/>- leaveRoom()<br/>- dissolveRoom()<br/>- updateRoom()<br/>- verifyPassword()<br/>- getRoomStats()"]
        end
        
        subgraph Routes["ğŸ›£ï¸ routes"]
            direction TB
            Router["createRoomRouter()<br/><br/>- POST /api/rooms<br/>- GET /api/rooms<br/>- GET /api/rooms/:id<br/>- POST /api/rooms/:id/join<br/>- POST /api/rooms/:id/leave<br/>- DELETE /api/rooms/:id"]
        end
        
        subgraph Middlewares["âš™ï¸ middlewares"]
            direction TB
            ErrorMid["errorHandler<br/><br/>- å…¨å±€é”™è¯¯å¤„ç†<br/>- å¼‚å¸¸è½¬æ¢"]
            LogMid["requestLogger<br/><br/>- è¯·æ±‚æ—¥å¿—è®°å½•<br/>- æ€§èƒ½ç›‘æ§"]
        end
        
        subgraph MainApp["ğŸ“± app.js"]
            direction TB
            AppFile["createApp()<br/>startServer()<br/><br/>- åˆå§‹åŒ–Express<br/>- æ³¨å†Œä¸­é—´ä»¶<br/>- æŒ‚è½½è·¯ç”±<br/>- å¯åŠ¨æœåŠ¡å™¨"]
        end
    end
    
    RoomCtrl -->|è·¯ç”±æ˜ å°„| Router
    Router -->|ä½¿ç”¨| Middlewares
    AppFile -->|é…ç½®| RoomCtrl
    AppFile -->|é…ç½®| Middlewares
    AppFile -->|å¯åŠ¨| Router
    
    style AppLayer fill:#E1F5FF
    style RoomCtrl fill:#B3E5FC
    style Router fill:#81D4FA
    style Middlewares fill:#4FC3F7
    style MainApp fill:#29B6F6
```

### 2.3 ä¸šåŠ¡é€»è¾‘å±‚åŒ…å›¾

```mermaid
graph TB
    subgraph BizLayer["ä¸šåŠ¡é€»è¾‘å±‚ (Business Logic)"]
        subgraph Services["ğŸ”§ services"]
            direction TB
            RoomSvc["RoomService<br/><br/>åˆ›å»ºæˆ¿é—´<br/>- createRoom()<br/>- validateCreateParams()<br/><br/>æŸ¥è¯¢æˆ¿é—´<br/>- getRoomList()<br/>- getRoomDetail()<br/>- getRoomStats()<br/><br/>å‚ä¸è€…ç®¡ç†<br/>- joinRoom()<br/>- leaveRoom()<br/><br/>æˆ¿é—´ç®¡ç†<br/>- dissolveRoom()<br/>- updateRoom()<br/><br/>éªŒè¯<br/>- verifyRoomPassword()"]
        end
        
        subgraph Exceptions["âŒ exceptions"]
            direction TB
            Base["BusinessException<br/>â–  errorCode<br/>â–  statusCode"]
            
            NotFound["RoomNotFoundException<br/>404"]
            Full["RoomFullException<br/>409"]
            InvalidPwd["InvalidPasswordException<br/>401"]
            PermDenied["PermissionDeniedException<br/>403"]
            Validation["ValidationException<br/>400"]
            Closed["RoomClosedException<br/>410"]
        end
    end
    
    RoomSvc -->|æŠ›å‡ºå¼‚å¸¸| Base
    Base --> NotFound
    Base --> Full
    Base --> InvalidPwd
    Base --> PermDenied
    Base --> Validation
    Base --> Closed
    
    style BizLayer fill:#F3E5F5
    style Services fill:#E1BEE7
    style Exceptions fill:#CE93D8
    style Base fill:#BA68C8
```

### 2.4 æ•°æ®è®¿é—®å±‚å’Œæ¨¡å‹å±‚åŒ…å›¾

```mermaid
graph TB
    subgraph DataLayer["æ•°æ®è®¿é—®å±‚ (Data Access)"]
        subgraph Repositories["ğŸ“¦ repositories"]
            direction TB
            RoomRepo["RoomRepository<br/><br/>CRUDæ“ä½œ<br/>- create()<br/>- findById()<br/>- findAll()<br/>- update()<br/>- delete()<br/><br/>æŸ¥è¯¢æ“ä½œ<br/>- exists()<br/>- count()<br/>- search()<br/><br/>å†…éƒ¨æ–¹æ³•<br/>- generateUniqueRoomId()"]
        end
    end
    
    subgraph ModelLayer["å®ä½“æ¨¡å‹å±‚ (Entity)"]
        subgraph Models["ğŸ›ï¸ models"]
            direction TB
            Room["Room (èšåˆæ ¹)<br/>â–  id<br/>â–  name<br/>â–  capacity<br/>â–  password<br/>â–  status<br/>â–  participants<br/>â–  videoState<br/>â–  createTime<br/><br/>+ addParticipant()<br/>+ removeParticipant()<br/>+ validatePassword()<br/>+ isFull()"]
            
            Video["VideoState<br/>â–  source<br/>â–  status<br/>â–  progress<br/>â–  playbackRate<br/>â–  subtitle<br/><br/>+ setSource()<br/>+ setStatus()<br/>+ getCurrentProgress()"]
            
            Participant["Participant<br/>â–  id<br/>â–  nickname<br/>â–  role<br/>â–  status<br/>â–  joinTime<br/><br/>+ isCreator()<br/>+ setStatus()"]
            
            ModelIndex["index.js<br/>ç»Ÿä¸€å¯¼å‡ºæ‰€æœ‰å®ä½“"]
        end
    end
    
    RoomRepo -->|ç®¡ç†| Room
    RoomRepo -->|ç®¡ç†| Video
    RoomRepo -->|ç®¡ç†| Participant
    Room -->|åŒ…å«| Video
    Room -->|åŒ…å«| Participant
    ModelIndex -->|å¯¼å‡º| Room
    ModelIndex -->|å¯¼å‡º| Video
    ModelIndex -->|å¯¼å‡º| Participant
    
    style DataLayer fill:#E8F5E9
    style Repositories fill:#C8E6C9
    style ModelLayer fill:#FFF3E0
    style Models fill:#FFE0B2
    style Room fill:#FFCC80
    style Video fill:#FFCC80
    style Participant fill:#FFCC80
```

### 2.5 åŸºç¡€è®¾æ–½å±‚åŒ…å›¾

```mermaid
graph TB
    subgraph InfraLayer["åŸºç¡€è®¾æ–½å±‚ (Infrastructure)"]
        subgraph Utils["ğŸ”¨ utils"]
            direction TB
            RespHelper["ResponseHelper<br/>â–  é™æ€æ–¹æ³•<br/><br/>æˆåŠŸå“åº”<br/>+ success()<br/>+ created()<br/><br/>é”™è¯¯å“åº”<br/>+ error()<br/>+ badRequest()<br/>+ unauthorized()<br/>+ forbidden()<br/>+ notFound()<br/>+ conflict()<br/>+ serverError()"]
            
            IdGen["IdGenerator<br/>â–  é™æ€æ–¹æ³•<br/><br/>IDç”Ÿæˆ<br/>+ generateRoomId()<br/>+ generateUUID()<br/>+ generateTimestampId()"]
        end
        
        subgraph ConfigPkg["âš™ï¸ config"]
            direction TB
            Config["index.js<br/><br/>serveré…ç½®<br/>- port<br/>- host<br/><br/>roomé…ç½®<br/>- nameMinLength<br/>- nameMaxLength<br/>- minCapacity<br/>- maxCapacity<br/>- defaultCapacity<br/>- roomIdLength<br/><br/>corsé…ç½®<br/>- origin<br/>- methods<br/>- allowedHeaders"]
        end
    end
    
    style InfraLayer fill:#F1F8E9
    style Utils fill:#DCEDC8
    style ConfigPkg fill:#C5E1A5
    style RespHelper fill:#AED581
    style IdGen fill:#AED581
    style Config fill:#9CCC65
```

---

## 3. å±‚é—´æ¥å£å®šä¹‰

### 3.1 åº”ç”¨å±‚ â†” ä¸šåŠ¡é€»è¾‘å±‚æ¥å£

```javascript
/**
 * RoomService æ¥å£å®šä¹‰
 */
interface IRoomService {
  // æˆ¿é—´åˆ›å»º
  createRoom(data: {
    name: string;
    capacity?: number;
    password?: string;
    announcement?: string;
    creatorNickname: string;
  }): Promise<{
    room: RoomDetail;
    creator: { id: string; nickname: string; role: string };
  }>;

  // æˆ¿é—´æŸ¥è¯¢
  getRoomList(options: {
    keyword?: string;
    status?: string;
    page?: number;
    pageSize?: number;
  }): Promise<{
    list: RoomSummary[];
    pagination: { page: number; pageSize: number; total: number; totalPages: number };
  }>;

  getRoomDetail(roomId: string): Promise<RoomDetail>;

  // å‚ä¸è€…ç®¡ç†
  joinRoom(roomId: string, data: {
    nickname: string;
    password?: string;
  }): Promise<{
    room: RoomDetail;
    participant: ParticipantInfo;
  }>;

  leaveRoom(roomId: string, participantId: string): Promise<boolean>;

  // æˆ¿é—´ç®¡ç†
  dissolveRoom(roomId: string, operatorId: string): Promise<boolean>;

  updateRoom(roomId: string, operatorId: string, data: {
    name?: string;
    capacity?: number;
    password?: string;
    announcement?: string;
  }): Promise<RoomDetail>;

  // éªŒè¯
  verifyRoomPassword(roomId: string, password: string): Promise<boolean>;

  // ç»Ÿè®¡
  getRoomStats(): Promise<{
    totalRooms: number;
    totalParticipants: number;
    waitingRooms: number;
    playingRooms: number;
  }>;
}
```

### 3.2 ä¸šåŠ¡é€»è¾‘å±‚ â†” æ•°æ®è®¿é—®å±‚æ¥å£

```javascript
/**
 * RoomRepository æ¥å£å®šä¹‰
 */
interface IRoomRepository {
  // åˆ›å»º
  create(data: {
    name: string;
    capacity: number;
    password?: string;
    announcement: string;
    creatorId: string;
    creatorNickname: string;
  }): Room;

  // æŸ¥è¯¢
  findById(roomId: string): Room | null;

  findAll(options?: {
    excludeClosed?: boolean;
  }): Room[];

  // æ›´æ–°
  update(roomId: string, data: any): Room | null;

  // åˆ é™¤
  delete(roomId: string): boolean;

  // æ£€æŸ¥
  exists(roomId: string): boolean;

  // ç»Ÿè®¡
  count(excludeClosed?: boolean): number;

  // æœç´¢
  search(criteria: {
    keyword?: string;
    status?: string;
    hasPassword?: boolean;
  }): Room[];
}
```

### 3.3 æ•°æ®è®¿é—®å±‚ â†” å®ä½“æ¨¡å‹å±‚æ¥å£

```javascript
/**
 * Entity åŸºç¡€æ¥å£
 */
interface IEntity {
  id: string;
  toJSON(): Object;
}

/**
 * Room èšåˆæ ¹æ¥å£
 */
interface IRoom extends IEntity {
  // å±æ€§
  id: string;
  name: string;
  capacity: number;
  status: string;
  participants: Map<string, Participant>;
  videoState: VideoState;
  creatorId: string;

  // ä¸šåŠ¡æ–¹æ³•
  addParticipant(data: any): Participant | null;
  removeParticipant(participantId: string): boolean;
  getParticipant(participantId: string): Participant | undefined;
  isFull(): boolean;
  isCreator(participantId: string): boolean;
  validatePassword(password: string): boolean;
  updateConfig(config: any): void;
  close(): void;
}
```

---

## 4. æ€»ä½“åŒ…ä¾èµ–å…³ç³»

```mermaid
graph LR
    A["Application<br/>åº”ç”¨å±‚"]
    B["Business Logic<br/>ä¸šåŠ¡é€»è¾‘å±‚"]
    D["Data Access<br/>æ•°æ®è®¿é—®å±‚"]
    M["Entity Model<br/>å®ä½“æ¨¡å‹å±‚"]
    I["Infrastructure<br/>åŸºç¡€è®¾æ–½å±‚"]
    
    A -->|è°ƒç”¨| B
    A -->|ä½¿ç”¨| I
    B -->|è°ƒç”¨| D
    B -->|ä½¿ç”¨| I
    B -->|throws| E["Exceptions<br/>å¼‚å¸¸ä½“ç³»"]
    D -->|æ“ä½œ| M
    D -->|ä½¿ç”¨| I
    
    style A fill:#E1F5FF
    style B fill:#F3E5F5
    style D fill:#E8F5E9
    style M fill:#FFF3E0
    style I fill:#F1F8E9
    style E fill:#FFEBEE
```

---

## 5. æ•°æ®æµå‘å›¾

```mermaid
graph TD
    Client["å‰ç«¯å®¢æˆ·ç«¯"]
    Controller["Controller<br/>RoomController"]
    Service["Service<br/>RoomService"]
    Repository["Repository<br/>RoomRepository"]
    Entity["Entity<br/>Room/Participant"]
    Storage["Memory Storage<br/>Map"]
    
    Client -->|HTTP Request<br/>JSON| Controller
    Controller -->|éªŒè¯å‚æ•°| Service
    Service -->|ä¸šåŠ¡é€»è¾‘| Service
    Service -->|CRUDæ“ä½œ| Repository
    Repository -->|åˆ›å»º/ä¿®æ”¹| Entity
    Repository -->|ä¿å­˜/æŸ¥è¯¢| Storage
    Storage -->|è¿”å›æ•°æ®| Repository
    Repository -->|è¿”å›Entity| Service
    Service -->|è¿”å›ç»“æœ| Controller
    Controller -->|HTTP Response<br/>JSON| Client
    
    style Client fill:#BBDEFB
    style Controller fill:#C8E6C9
    style Service fill:#F8BBD0
    style Repository fill:#FFCCBC
    style Entity fill:#FFE0B2
    style Storage fill:#D1C4E9
```

---

## 6. æ¨¡å—åŒ–æ¨¡å¼è¯´æ˜

### å•ä¾‹æ¨¡å¼å®ç°

```javascript
// RoomService çš„å•ä¾‹å®ç°
class RoomService {
  static instance = null;
  
  static getInstance() {
    if (!RoomService.instance) {
      RoomService.instance = new RoomService();
    }
    return RoomService.instance;
  }
  
  constructor() {
    this.roomRepository = RoomRepository.getInstance();
  }
}

// ä½¿ç”¨æ–¹å¼
const roomService = RoomService.getInstance();
```

### å·¥å‚æ¨¡å¼å®ç°

```javascript
// è·¯ç”±åˆ›å»ºå·¥å‚
const createRoomRouter = () => {
  const router = express.Router();
  const roomController = RoomController.getInstance();
  
  router.get('/', roomController.getRoomList);
  router.post('/', roomController.createRoom);
  // ... å…¶ä»–è·¯ç”±
  
  return router;
};

// åº”ç”¨ä¸­ä½¿ç”¨
app.use('/api/rooms', createRoomRouter());
```

### èšåˆæ ¹æ¨¡å¼å®ç°

```javascript
// Room ä½œä¸ºèšåˆæ ¹ï¼Œç®¡ç† VideoState å’Œ Participant
class Room {
  constructor(options) {
    this.videoState = new VideoState();
    this.participants = new Map();
  }
  
  addParticipant(participantData) {
    const participant = new Participant(participantData);
    this.participants.set(participant.id, participant);
    return participant;
  }
  
  // Room è´Ÿè´£ç®¡ç†å…¶æ‰€æœ‰å­å®ä½“çš„ä¸šåŠ¡è§„åˆ™
}
```
