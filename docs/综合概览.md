# 房间管理模块 - 综合概览

## 项目概览

房间管理模块是在线观影室系统的核心子模块，负责线上观影室的创建、配置、成员管理和生命周期管理。

### 核心功能

| 功能 | 描述 | 状态 |
|------|------|------|
| 创建房间 | 创建线上观影室，设置房间配置 | ✅ 已实现 |
| 房间列表 | 查看所有可用房间，支持搜索和分页 | ✅ 已实现 |
| 房间详情 | 查看房间的详细信息和参与者列表 | ✅ 已实现 |
| 加入房间 | 观众加入指定房间，支持密码验证 | ✅ 已实现 |
| 退出房间 | 观众退出当前所在房间 | ✅ 已实现 |
| 解散房间 | 房间创建者解散房间 | ✅ 已实现 |
| 房间配置 | 房间创建者修改房间配置 | ✅ 已实现 |
| 房间统计 | 获取系统的房间和参与者统计数据 | ✅ 已实现 |

---

## 项目结构

```
backend-online-movie-house/
│
├── src/                           # 源代码目录
│   ├── app.js                     # 应用主入口
│   │
│   ├── config/                    # 配置管理
│   │   └── index.js               # 应用配置文件
│   │
│   ├── models/                    # 实体模型层
│   │   ├── index.js               # 模型导出
│   │   ├── Room.js                # 房间实体（聚合根）
│   │   ├── Participant.js         # 参与者实体
│   │   └── VideoState.js          # 视频状态实体
│   │
│   ├── repositories/              # 数据访问层
│   │   └── RoomRepository.js      # 房间数据仓库
│   │
│   ├── services/                  # 业务逻辑层
│   │   └── RoomService.js         # 房间业务服务
│   │
│   ├── controllers/               # 控制器层
│   │   └── RoomController.js      # 房间控制器
│   │
│   ├── routes/                    # 路由定义
│   │   └── roomRoutes.js          # 房间路由
│   │
│   ├── middlewares/               # 中间件
│   │   ├── errorHandler.js        # 全局错误处理
│   │   └── requestLogger.js       # 请求日志
│   │
│   ├── exceptions/                # 异常定义
│   │   └── BusinessException.js   # 业务异常
│   │
│   └── utils/                     # 工具函数
│       ├── ResponseHelper.js      # 响应格式化
│       └── IdGenerator.js         # ID生成器
│
├── docs/                          # 文档目录
│   ├── 文档索引.md                # 文档导航
│   ├── 设计文档.md                # 架构和设计
│   ├── 类图和包图.md              # 结构图示
│   ├── 详细设计.md                # 实现细节
│   └── API文档.md                 # 接口规范
│
├── package.json                   # 项目配置和依赖
└── README.md                      # 项目说明
```

### 目录说明

| 目录 | 描述 | 关键文件 |
|------|------|---------|
| **src/config** | 应用配置 | index.js - 服务器、房间、CORS配置 |
| **src/models** | 数据模型 | Room、Participant、VideoState 实体 |
| **src/repositories** | 数据访问 | RoomRepository - 内存数据管理 |
| **src/services** | 业务逻辑 | RoomService - 核心业务规则 |
| **src/controllers** | HTTP处理 | RoomController - 请求/响应处理 |
| **src/routes** | 路由定义 | roomRoutes - RESTful API路由 |
| **src/middlewares** | 中间件 | 错误处理、日志、CORS等 |
| **src/exceptions** | 异常处理 | BusinessException - 异常体系 |
| **src/utils** | 工具类 | ResponseHelper、IdGenerator等 |
| **docs** | 文档 | 设计、API、开发指南等 |

---

## 架构设计总览

### 分层架构

房间管理模块采用经典的四层分层架构，确保代码的可维护性和可扩展性：

```
┌─────────────────────────────────────┐
│  应用层 (Controllers, Routes)        │ ← 处理HTTP请求/响应
├─────────────────────────────────────┤
│  业务逻辑层 (Services)               │ ← 实现业务规则
├─────────────────────────────────────┤
│  数据访问层 (Repositories)           │ ← 管理数据存储
├─────────────────────────────────────┤
│  模型层 (Entities)                   │ ← 定义数据结构
├─────────────────────────────────────┤
│  基础设施层 (Utils, Config)          │ ← 工具和配置
└─────────────────────────────────────┘
```

### 核心设计模式

| 模式 | 使用位置 | 作用 |
|------|---------|------|
| **单例模式** | Service, Repository, Controller | 全局唯一实例，保证数据一致性 |
| **聚合根** | Room 实体 | 管理 VideoState 和 Participant 的一致性 |
| **工厂模式** | 路由创建 | 创建和初始化路由实例 |
| **异常体系** | 错误处理 | 统一异常处理和转换 |
| **Repository** | 数据访问 | 屏蔽数据存储细节 |

---

## 数据模型

### 核心实体

#### Room（房间）- 聚合根

```javascript
{
  id: "123456",              // 房间号（6位数字）
  name: "周末观影派对",        // 房间名称
  capacity: 20,              // 人数上限
  password: "123456",        // 房间密码（可选）
  announcement: "欢迎加入",    // 房间公告
  status: "waiting",         // 状态：waiting, playing, closed
  
  // 聚合关系
  videoState: VideoState,    // 视频状态（1对1）
  participants: Map,         // 参与者列表（1对多）
  
  // 元数据
  creatorId: "uuid-xxx",     // 创建者ID
  createTime: Date,          // 创建时间
  updateTime: Date           // 更新时间
}
```

#### VideoState（视频状态）

```javascript
{
  source: "http://...",      // 视频源URL
  status: "paused",          // 播放状态：playing, paused, stopped
  progress: 0,               // 播放进度（秒）
  playbackRate: 1.0,         // 播放倍速
  subtitle: null,            // 字幕设置
  lastUpdateTime: 1234567    // 最后更新时间戳
}
```

#### Participant（参与者）

```javascript
{
  id: "uuid-yyy",            // 参与者ID
  nickname: "观众名字",       // 昵称
  role: "viewer",            // 角色：creator, viewer
  status: "online",          // 状态：online, offline
  joinTime: Date,            // 加入时间
  socketId: "socket-id"      // WebSocket连接ID
}
```

### 状态机

#### Room 状态转换

```
waiting ──→ playing ──→ closed
  ↑                        ↑
  └────────────────────────┘
```

#### Participant 状态转换

```
online ←→ offline
```

---

## API 接口总览

### 接口列表

| 方法 | 路径 | 功能 | 认证 |
|------|------|------|------|
| POST | /api/rooms | 创建房间 | ❌ |
| GET | /api/rooms | 获取房间列表 | ❌ |
| GET | /api/rooms/:roomId | 获取房间详情 | ❌ |
| POST | /api/rooms/:roomId/verify-password | 验证密码 | ❌ |
| POST | /api/rooms/:roomId/join | 加入房间 | ❌ |
| POST | /api/rooms/:roomId/leave | 退出房间 | ❌ |
| DELETE | /api/rooms/:roomId | 解散房间 | ✅ |
| PATCH | /api/rooms/:roomId | 更新房间配置 | ✅ |
| GET | /api/rooms/stats | 获取统计信息 | ❌ |

### 响应格式

#### 成功响应 (200-201)

```json
{
  "success": true,
  "code": 200,
  "message": "操作成功",
  "data": { /* 响应数据 */ },
  "timestamp": "2026-01-14T10:00:00.000Z"
}
```

#### 错误响应 (400-500)

```json
{
  "success": false,
  "code": 400,
  "message": "错误描述信息",
  "errorCode": "ERROR_CODE",
  "details": { /* 错误详情 */ },
  "timestamp": "2026-01-14T10:00:00.000Z"
}
```

### 错误码映射

| HTTP | 错误码 | 含义 |
|------|--------|------|
| 400 | BAD_REQUEST | 请求参数错误 |
| 400 | VALIDATION_ERROR | 参数验证失败 |
| 401 | INVALID_PASSWORD | 房间密码错误 |
| 403 | PERMISSION_DENIED | 权限不足 |
| 404 | ROOM_NOT_FOUND | 房间不存在 |
| 409 | ROOM_FULL | 房间已满 |
| 410 | ROOM_CLOSED | 房间已关闭 |
| 500 | INTERNAL_SERVER_ERROR | 服务器内部错误 |

---

## 实现特点

### ✅ 已实现的特性

- ✅ 完整的分层架构
- ✅ RESTful API 设计
- ✅ 参数验证和业务验证
- ✅ 统一异常处理
- ✅ 内存数据管理
- ✅ 房间搜索和分页
- ✅ 权限控制（创建者权限）
- ✅ 详细的API文档
- ✅ 完整的架构设计文档
- ✅ 类图和包图

### 🔄 后续计划

#### 第二迭代（同步控制模块）
- [ ] Socket.IO 实时通信
- [ ] 视频播放状态同步
- [ ] 客户端状态对齐
- [ ] 实时同步事件

#### 第三迭代（聊天互动模块）
- [ ] 消息收发
- [ ] 弹幕功能
- [ ] 聊天历史记录

#### 第四迭代（持久化存储）
- [ ] 数据库集成 (MongoDB/PostgreSQL)
- [ ] Redis 缓存
- [ ] 数据持久化

#### 第五迭代（微服务化）
- [ ] 拆分为独立微服务
- [ ] 服务间通信
- [ ] 分布式部署

---

## 快速开始

### 1. 环境要求

- Node.js >= 18.0.0
- npm >= 8.0.0

### 2. 安装依赖

```bash
npm install
```

### 3. 启动服务

```bash
# 生产模式
npm start

# 开发模式（支持热重载）
npm run dev
```

### 4. 验证服务

访问以下地址验证服务正常运行：

- 健康检查: http://localhost:3000/health
- API根路径: http://localhost:3000/api
- 房间API: http://localhost:3000/api/rooms

---

## 技术栈

| 层级 | 技术 | 版本 |
|------|------|------|
| **运行时** | Node.js | 25.2.1 |
| **框架** | Express.js | 5.2.1 |
| **存储** | 内存 Map | 原生 |
| **数据格式** | JSON | 原生 |

---

## 文档导引

### 📚 完整文档列表

| 文档 | 阅读时间 | 推荐对象 |
|------|---------|---------|
| [README.md](../README.md) | 5分钟 | 所有人 |
| [文档索引.md](文档索引.md) | 10分钟 | 所有人 |
| [设计文档.md](设计文档.md) | 30分钟 | 架构师、高级开发 |
| [类图和包图.md](类图和包图.md) | 20分钟 | 开发人员、设计人员 |
| [详细设计.md](详细设计.md) | 40分钟 | 开发人员 |
| [API文档.md](API文档.md) | 30分钟 | 前端开发、测试 |

### 🎯 按角色查找

- **项目经理** → 阅读本文档 + [设计文档](设计文档.md)
- **架构师** → [设计文档](设计文档.md) + [类图和包图](类图和包图.md)
- **后端开发** → [详细设计](详细设计.md) + 源代码
- **前端开发** → [API文档](API文档.md)
- **测试人员** → [API文档](API文档.md) + [详细设计](详细设计.md)

---

## 设计亮点

### 1. 清晰的分层架构

- **应用层** 与 **业务层** 解耦
- **业务层** 与 **数据层** 解耦
- 便于独立开发、测试和部署

### 2. 完善的异常体系

```
BusinessException (基类)
  ├── RoomNotFoundException
  ├── RoomFullException
  ├── InvalidPasswordException
  ├── PermissionDeniedException
  ├── ValidationException
  └── RoomClosedException
```

### 3. 单例模式应用

- RoomService、RoomRepository、RoomController
- 保证全局唯一性
- 共享数据一致性

### 4. 聚合根模式

- Room 作为聚合根
- 管理 VideoState 和 Participant 的一致性
- 实现复杂业务规则

### 5. 为微服务化预留的设计

- Repository 抽象便于数据库迁移
- 模块化设计支持功能拆分
- Service 接口清晰易于服务化

---

## 部署考虑

### 当前环境要求

- Node.js 25.2.1
- 内存存储（数据临时性）
- 单服务器部署

### 生产环境注意事项

1. **数据持久化** - 当前使用内存存储，服务重启会丢失数据
2. **并发限制** - 当前无并发控制，建议添加限流
3. **安全增强** - 建议添加身份认证和授权
4. **性能优化** - 建议添加缓存（Redis）
5. **监控告警** - 建议集成监控系统

---

## 常见问题

### Q: 为什么要这样分层？

A: 分层设计遵循 SOLID 原则，提高代码的可维护性、可测试性和可扩展性。详见 [设计文档 - 架构设计原则](设计文档.md#2-架构设计原则)。

### Q: 如何添加新功能？

A: 按照分层架构，从 Model 层开始，逐层向上实现。详见 [文档索引 - 常见问题](文档索引.md#q3-如何添加新功能)。

### Q: 如何从内存存储迁移到数据库？

A: 只需修改 RoomRepository 的实现，Service 和 Controller 无需改动。详见 [文档索引 - 常见问题](文档索引.md#q4-如何从内存存储迁移到数据库)。

### Q: 如何处理并发访问？

A: 当前设计支持基本并发。对于生产环境，建议：
1. 使用数据库的事务机制
2. 添加分布式锁
3. 实现乐观锁或悲观锁

### Q: 如何扩展到微服务？

A: 当前模块化设计已为微服务化预留了接口。可以：
1. 将 RoomService 拆分为独立微服务
2. 通过 gRPC 或 REST API 调用
3. 使用消息队列解耦

---

## 团队协作

### 分工建议

| 角色 | 责任 | 文档 |
|------|------|------|
| 架构师 | 架构设计、性能优化 | [设计文档](设计文档.md) |
| 高级开发 | 核心功能实现、Code Review | [详细设计](详细设计.md) |
| 普通开发 | 功能实现、单元测试 | 源代码 + 注释 |
| 前端开发 | 前端集成、界面开发 | [API文档](API文档.md) |
| 测试人员 | 功能测试、性能测试 | [API文档](API文档.md) + [详细设计](详细设计.md) |

### 代码规范

- 遵循 JSDoc 注释规范
- 使用 ES6+ 语法
- 采用单例模式管理全局状态
- 异常优先于错误码
- Service 层包含所有业务逻辑

---

## 性能指标

### 当前性能

| 指标 | 值 | 说明 |
|------|-----|------|
| API响应时间 | < 100ms | 内存操作 |
| 数据库查询 | O(1) | Map哈希表 |
| 搜索复杂度 | O(n) | 线性搜索 |
| 并发支持 | 基础 | 内存限制 |
| 内存占用 | 线性增长 | 随房间数增长 |

### 优化建议

- **短期** - 添加缓存、优化搜索算法
- **中期** - 集成数据库、添加索引
- **长期** - 分布式部署、微服务化

---

## 贡献指南

### 提交代码前

1. ✅ 代码遵循项目规范
2. ✅ 添加相应的注释和文档
3. ✅ 编写单元测试
4. ✅ 通过所有测试
5. ✅ 更新相关文档

### 提交文档前

1. ✅ 文档清晰准确
2. ✅ 示例代码可运行
3. ✅ 与实现代码同步
4. ✅ 遵循文档格式规范

---

## 许可证

ISC

---

## 联系方式

- 问题报告: 开发团队
- 技术支持: 架构师团队
- 文档维护: 文档团队

---

**项目版本**: 1.0.0  
**最后更新**: 2026-01-14  
**下一个迭代**: 同步控制模块  
**维护者**: 开发团队
