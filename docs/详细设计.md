# 详细设计文档

## 1. 需求分析

### 1.1 功能需求

根据"参与社交影院"用例的基本流，房间管理模块需要实现以下核心功能：

| 编号 | 功能名称 | 描述 |
|------|---------|------|
| F1 | 创建房间 | 放映厅创建者可以创建新的线上观影室 |
| F2 | 房间配置 | 设置房间名称、人数上限、密码、公告等信息 |
| F3 | 查看房间列表 | 观众可以浏览所有可用的房间 |
| F4 | 搜索房间 | 支持按关键词或房间号搜索房间 |
| F5 | 验证房间密码 | 加入有密码的房间前进行密码验证 |
| F6 | 加入房间 | 观众可以加入指定的房间 |
| F7 | 退出房间 | 观众可以退出当前所在房间 |
| F8 | 解散房间 | 房间创建者可以解散房间 |
| F9 | 更新房间配置 | 房间创建者可以修改房间配置 |
| F10 | 房间统计 | 系统可以统计房间和参与者数据 |

### 1.2 非功能需求

| 需求类型 | 描述 | 目标 |
|---------|------|------|
| 性能 | API响应时间 | < 200ms |
| 可用性 | 系统可用性 | > 99% |
| 可维护性 | 代码质量 | 遵循SOLID原则 |
| 可扩展性 | 模块化设计 | 支持未来功能扩展 |
| 安全性 | 参数验证 | 所有输入都需验证 |
| 并发 | 单服务器 | 支持基本并发 |

---

## 2. 设计详情

### 2.1 Room 实体设计

#### 2.1.1 类职责

**聚合根角色** - Room 是房间管理的核心聚合根，负责：

1. **状态管理**
   - 管理房间的生命周期（创建 → 活跃 → 关闭）
   - 维护房间配置信息
   - 跟踪参与者集合

2. **业务规则实施**
   - 验证房间密码
   - 检查房间容量
   - 管理参与者权限

3. **子实体管理**
   - 聚合 VideoState（视频状态）
   - 聚合 Participant 集合（参与者）
   - 确保子实体的一致性

#### 2.1.2 属性设计

| 属性 | 类型 | 长度/范围 | 说明 | 初始值 |
|------|------|---------|------|--------|
| id | String | 6位 | 房间号，唯一标识 | 随机生成 |
| name | String | 1-50 | 房间名称 | 必填 |
| capacity | Number | 2-100 | 人数上限 | 默认10 |
| password | String/Null | 0-20 | 房间密码 | Null |
| announcement | String | 0-500 | 房间公告 | 空字符串 |
| status | String Enum | - | 房间状态 | waiting |
| videoState | VideoState | - | 视频状态引用 | 新建实例 |
| participants | Map | - | 参与者映射表 | 空Map |
| creatorId | String | - | 创建者ID | 必填 |
| createTime | Date | - | 创建时间 | 当前时间 |
| updateTime | Date | - | 更新时间 | 当前时间 |

#### 2.1.3 方法设计

**查询方法**

```javascript
hasPassword() boolean
  - 检查房间是否设置了密码
  - 返回: password != null && password != ''

validatePassword(password: string) boolean
  - 验证输入的密码是否与房间密码匹配
  - 如果房间未设密码，直接返回true
  - 参数: password - 待验证的密码
  - 返回: 密码是否正确

isFull() boolean
  - 检查房间是否已满员
  - 返回: participants.size >= capacity

getOnlineCount() number
  - 获取当前在线人数
  - 返回: 在线状态的参与者数量

isCreator(participantId: string) boolean
  - 检查指定参与者是否为房间创建者
  - 参数: participantId - 参与者ID
  - 返回: participantId == creatorId

getParticipant(participantId: string) Participant
  - 获取指定参与者
  - 参数: participantId - 参与者ID
  - 返回: 参与者实例或undefined

getCreator() Participant
  - 获取房间创建者
  - 返回: creatorId对应的参与者
```

**修改方法**

```javascript
addParticipant(participantData: object) Participant | null
  - 添加参与者到房间
  - 检查房间是否已满
  - 创建Participant实例并添加到participants Map
  - 更新updateTime
  - 参数: participantData - 参与者数据对象
  - 返回: 添加的Participant或null（房间已满）

removeParticipant(participantId: string) boolean
  - 移除指定参与者
  - 参数: participantId - 参与者ID
  - 返回: 移除是否成功

updateConfig(config: object) void
  - 批量更新房间配置
  - 支持更新: name, capacity, password, announcement
  - 更新updateTime
  - 参数: config - 配置对象

setStatus(status: string) void
  - 设置房间状态
  - 验证status值是否有效
  - 更新updateTime
  - 参数: status - 新状态值

close() void
  - 关闭房间
  - 设置status为'closed'
  - 更新updateTime
```

**序列化方法**

```javascript
toListJSON() object
  - 返回房间列表展示所需的信息
  - 返回字段: id, name, capacity, currentCount, 
             hasPassword, status, creatorNickname, createTime
  - 用途: 房间列表API响应

toDetailJSON() object
  - 返回房间详情展示所需的完整信息
  - 包含: 房间所有信息 + 参与者列表 + 视频状态
  - 用途: 房间详情API响应
```

### 2.2 RoomService 业务逻辑设计

#### 2.2.1 验证规则

**房间名称验证**

```
输入: name (string)
规则:
  1. 非空且字符串类型
  2. trim()后长度: [1, 50]
错误码: VALIDATION_ERROR (400)
```

**人数上限验证**

```
输入: capacity (number)
规则:
  1. 必须是整数
  2. 范围: [2, 100]
  3. 默认值: 10
错误码: VALIDATION_ERROR (400)
```

**密码验证**

```
输入: password (string, optional)
规则:
  1. 如果提供，长度不超过20
  2. 可以为空或null（表示无密码）
错误码: VALIDATION_ERROR (400)
```

**公告验证**

```
输入: announcement (string, optional)
规则:
  1. 长度不超过500
  2. 可以为空
错误码: VALIDATION_ERROR (400)
```

**昵称验证**

```
输入: nickname (string)
规则:
  1. 非空且字符串类型
  2. trim()后非空
错误码: VALIDATION_ERROR (400)
```

#### 2.2.2 业务流程

**创建房间流程**

```
1. 验证参数合法性 → ValidationException
2. 生成创建者ID (UUID)
3. 生成唯一房间号 (6位数字)
4. 创建Room实例
5. 调用Repository.create()保存
6. 返回 { room, creator } 对象
```

**加入房间流程**

```
1. 查询房间是否存在 → RoomNotFoundException
2. 检查房间是否已关闭 → RoomClosedException
3. 检查房间是否已满 → RoomFullException
4. 验证密码（如果需要） → InvalidPasswordException
5. 验证昵称格式 → ValidationException
6. 生成参与者ID (UUID)
7. 调用Room.addParticipant()
8. 返回 { room, participant } 对象
```

**解散房间流程**

```
1. 查询房间是否存在 → RoomNotFoundException
2. 验证操作者是否为创建者 → PermissionDeniedException
3. 调用Room.close()设置状态
4. 调用Repository.delete()移除房间
5. 返回true
```

**更新房间流程**

```
1. 查询房间是否存在 → RoomNotFoundException
2. 验证操作者是否为创建者 → PermissionDeniedException
3. 验证更新数据合法性 → ValidationException
4. 调用Room.updateConfig()
5. 返回更新后的房间详情
```

#### 2.2.3 异常处理策略

| 异常类型 | HTTP状态码 | 适用场景 |
|---------|----------|---------|
| RoomNotFoundException | 404 | 房间不存在 |
| RoomFullException | 409 | 房间已满 |
| InvalidPasswordException | 401 | 密码错误 |
| PermissionDeniedException | 403 | 无操作权限 |
| ValidationException | 400 | 参数验证失败 |
| RoomClosedException | 410 | 房间已关闭 |

### 2.3 RoomRepository 数据访问设计

#### 2.3.1 数据存储

**使用 Map 实现内存存储**

```javascript
private rooms = new Map<string, Room>()
  Key: 房间ID (String)
  Value: Room 实例
```

**存储特点**

- 使用内存存储（第一迭代）
- O(1) 查询时间复杂度
- 服务重启数据丢失
- 为数据库迁移预留了接口

#### 2.3.2 CRUD 操作

**Create (创建)**

```javascript
create(roomData) {
  1. 调用 generateUniqueRoomId() 生成房间号
  2. 创建 Room 实例
  3. rooms.set(roomId, room)
  4. 返回 room
}
```

**Read (读取)**

```javascript
findById(roomId) {
  1. 返回 rooms.get(roomId) || null
}

findAll(options) {
  1. 获取所有房间
  2. 如果 excludeClosed=true，过滤已关闭房间
  3. 返回房间数组
}
```

**Update (更新)**

```javascript
update(roomId, updateData) {
  1. 查找房间
  2. 调用 room.updateConfig(updateData)
  3. 返回更新后的房间
}
```

**Delete (删除)**

```javascript
delete(roomId) {
  1. 删除房间
  2. return rooms.delete(roomId)
}
```

#### 2.3.3 查询操作

**Search (搜索)**

```javascript
search(criteria) {
  const rooms = this.findAll({ excludeClosed: true });
  
  // 关键词搜索（房间名称或房间号）
  if (criteria.keyword) {
    rooms = rooms.filter(room => 
      room.name.toLowerCase().includes(keyword.toLowerCase()) ||
      room.id.includes(keyword)
    );
  }
  
  // 状态过滤
  if (criteria.status) {
    rooms = rooms.filter(room => room.status === criteria.status);
  }
  
  // 密码过滤
  if (criteria.hasPassword !== undefined) {
    rooms = rooms.filter(room => 
      room.hasPassword() === criteria.hasPassword
    );
  }
  
  return rooms;
}
```

**分页处理**

```javascript
分页在Service层实现：
1. 调用 search() 或 findAll() 获取完整列表
2. 在内存中进行分页计算
3. 返回 { list, pagination }
```

### 2.4 RoomController 请求处理设计

#### 2.4.1 参数提取

**参数来源**

| 方法 | POST参数 | GET参数 | 路径参数 |
|------|---------|---------|---------|
| createRoom | ✓ | | |
| getRoomList | | ✓ | |
| getRoomDetail | | | ✓ |
| joinRoom | ✓ | | ✓ |
| leaveRoom | ✓ | | ✓ |
| dissolveRoom | ✓ | | ✓ |
| updateRoom | ✓ | | ✓ |
| verifyPassword | ✓ | | ✓ |

**参数验证职责**

- 参数提取：Controller负责
- 类型转换：Controller负责
- 业务验证：Service负责
- 边界检查：Service负责

#### 2.4.2 错误处理

**处理流程**

```
1. try-catch 捕获异常
2. 调用 next(error) 传递给错误中间件
3. 错误中间件统一处理
4. 返回标准错误响应
```

**不同异常处理**

```javascript
// BusinessException
→ 提取 errorCode 和 statusCode
→ 调用 ResponseHelper.error()
→ 返回统一格式响应

// 其他异常
→ 打印日志
→ 返回 500 Internal Server Error
```

#### 2.4.3 响应格式

**成功响应**

```javascript
{
  success: true,
  code: 200,
  message: "操作成功",
  data: { ... },
  timestamp: "ISO8601"
}
```

**错误响应**

```javascript
{
  success: false,
  code: 400,
  message: "错误描述",
  errorCode: "ERROR_CODE",
  details: null,
  timestamp: "ISO8601"
}
```

---

## 3. 关键设计决策

### 3.1 为什么选择单例模式？

**优势**

- 全局唯一实例，保证数据一致性
- 共享内存中的Room和Participant数据
- 减少内存占用

**实现**

```javascript
static getInstance() {
  if (!RoomService.instance) {
    RoomService.instance = new RoomService();
  }
  return RoomService.instance;
}
```

### 3.2 为什么采用聚合根模式？

**优势**

- Room作为聚合根，保证数据一致性
- VideoState和Participant通过Room管理
- 业务规则在聚合根中实现
- 便于事务管理

**实例**

```javascript
// 添加参与者时检查房间容量
addParticipant(participantData) {
  if (this.isFull()) {
    return null;
  }
  // 添加逻辑
}
```

### 3.3 为什么分离 Service 和 Repository？

**优势**

- 职责清晰：Service处理业务逻辑，Repository处理数据访问
- 便于测试：可以Mock Repository
- 便于迁移：将来替换Repository实现而无需改动Service

### 3.4 为什么使用异常体系而非错误码？

**优势**

- 异常流和正常流分离
- 自动异常传播
- 类型安全
- 便于调试

**示例**

```javascript
// 异常方式（推荐）
if (!room) {
  throw new RoomNotFoundException(roomId);
}

// vs 错误码方式（不推荐）
if (!room) {
  return { success: false, errorCode: 'ROOM_NOT_FOUND' };
}
```

### 3.5 为什么参数验证在 Service 层？

**原因**

- Controller关注HTTP细节
- Service关注业务逻辑
- 验证规则随业务逻辑变化
- 便于复用（API和其他客户端共用）

---

## 4. 性能考虑

### 4.1 时间复杂度分析

| 操作 | 复杂度 | 说明 |
|------|--------|------|
| 创建房间 | O(n) | 生成唯一房间号需要遍历检查 |
| 查询房间 | O(1) | 直接Map查询 |
| 列出房间 | O(n) | 遍历所有房间 |
| 搜索房间 | O(n*m) | 需要遍历和字符串匹配 |
| 添加参与者 | O(1) | Map插入 |
| 移除参与者 | O(1) | Map删除 |
| 分页 | O(n) | 内存分页 |

### 4.2 空间复杂度分析

| 数据结构 | 复杂度 | 说明 |
|---------|--------|------|
| rooms Map | O(r) | r = 房间数 |
| participants Map | O(p) | p = 参与者数 |
| videoState | O(1) | 固定大小对象 |

### 4.3 优化建议

**短期优化** (无需架构改变)
- 使用索引加速搜索
- 缓存热点查询
- 异步处理不关键操作

**长期优化** (需要架构升级)
- 使用数据库（MongoDB/PostgreSQL）
- 使用Redis缓存
- 添加搜索引擎（Elasticsearch）
- 拆分为微服务

---

## 5. 安全性考虑

### 5.1 输入验证

**所有用户输入都需验证**

```javascript
// 房间名称
- 非空
- 长度范围检查
- 特殊字符过滤（可选）

// 密码
- 长度范围检查
- 不进行加密（第一迭代）

// 昵称
- 非空
- 长度范围检查
```

### 5.2 权限控制

**操作者身份验证**

```javascript
// 解散房间：只允许创建者
if (!room.isCreator(operatorId)) {
  throw new PermissionDeniedException('解散房间');
}

// 更新配置：只允许创建者
if (!room.isCreator(operatorId)) {
  throw new PermissionDeniedException('更新房间配置');
}
```

### 5.3 数据隐私

**不在日志中记录敏感信息**

```javascript
// ✓ 可以记录
log.info(`用户 ${userId} 加入房间 ${roomId}`);

// ✗ 不应记录
log.info(`用户 ${userId} 加入房间，密码: ${password}`);
```

---

## 6. 可测试性设计

### 6.1 单元测试覆盖

**应该测试**

- Room 实体的业务规则
- RoomService 的业务逻辑
- RoomRepository 的CRUD操作
- 异常处理

**可以Mock的部分**

```javascript
// 测试Service
const mockRepository = {
  create: jest.fn(),
  findById: jest.fn(),
  // ...
};

const service = new RoomService();
service.roomRepository = mockRepository;
```

### 6.2 集成测试覆盖

**应该测试**

- 完整的API流程
- 参与者加入/退出流程
- 房间创建/解散流程

---

## 7. 日志设计

### 7.1 日志级别

| 级别 | 用途 | 示例 |
|------|------|------|
| ERROR | 错误和异常 | 房间创建失败，数据库连接错误 |
| WARN | 警告信息 | 房间容量接近满员 |
| INFO | 重要信息 | 用户加入房间，房间创建 |
| DEBUG | 调试信息 | 参数值，中间状态 |

### 7.2 日志内容

```javascript
// ✓ 应该记录
[INFO] 用户 ${userId} 加入房间 ${roomId}
[INFO] 房间 ${roomId} 已创建，容量 ${capacity}
[ERROR] 房间查询失败: ${roomId}

// ✗ 不应记录
[DEBUG] 房间密码: ${password}
[DEBUG] 用户密码: ${userPassword}
```

---

## 8. 文档维护

### 8.1 文档种类

1. **API文档** - 接口规范、请求/响应格式
2. **设计文档** - 架构、类设计、流程
3. **部署文档** - 安装、配置、运维
4. **开发指南** - 开发规范、代码示例

### 8.2 文档更新策略

- 代码变更时同时更新文档
- 新增功能时编写相应文档
- 定期审核文档准确性

---

## 总结

房间管理模块的详细设计涵盖了从需求分析到实现细节的各个方面。通过采用分层架构、设计模式和最佳实践，确保了代码的可维护性、可测试性和可扩展性，为未来的功能扩展和技术升级奠定了坚实的基础。
